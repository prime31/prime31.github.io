
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Modeling 2D Water With Springs: Part 2 - prime[31] blog - Unity tips, tricks and random thoughts</title>
  <meta name="author" content="Mike Desaro">

  
  <meta name="description" content="In part 1, all the groundwork for setting up the water simulation was laid. We have springs attached to the top verts of the water plane, which &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://blog.prime31.com/water2d-part2">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="prime[31] blog - Unity tips, tricks and random thoughts" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">prime[31] blog - Unity tips, tricks and random thoughts</a></h1>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:blog.prime31.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Modeling 2D Water With Springs: Part 2</h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-12-01T22:09:42-08:00'><span class='date'><span class='date-month'>Dec</span> <span class='date-day'>1</span><span class='date-suffix'>st</span>, <span class='date-year'>2014</span></span> <span class='time'>10:09 pm</span></time>
        
      </p>
    
  </header>


<div class="entry-content"><p>In part 1, all the groundwork for setting up the water simulation was laid. We have springs attached to the top verts of the water plane, which always want to remain in their neutral position. Once a force is applied to the springs they will oscillate back and forth based on the dampening and tension constants that are passed in.</p>

<!-- more -->


<p>At this point we have a Mesh (with a handy BoxCollider2D making it super easy to position and shape the water plane in the editor) and our WaterColumn struct ready to go, but nothing is happening yet. We need to implement an Update method and start applying some forces to the springs. There are different ways to get creative with this part so I&rsquo;ll just touch on this particular implementation. Right now the springs don&rsquo;t affect each other at all, which would make the water look pretty silly if we applied a force to any of our springs. We need to take into account what our neighbor springs are doing. Are the neighbor springs above or below the current spring? If so, apply a force in that direction based on how far it is from the current spring times some made up constant. Something like this (which shows only the spring to our right): <code>spring[i].velocity += konstant * ( spring[i].currentHeight - spring[i+1].currentHeight)</code>.</p>

<p>The final piece of the simulation is detecting when something falls in the water and applying an appropriate force. This is where our BoxCollider2D (which is set as a trigger) comes in handy. We use OnTriggerEnter2D to detect anything hitting the water, then use its velocity and mass to affect our springs. <img src="/images/posts/water2d/splash.png" alt="" /> The easy way to do this is to just find the nearest spring and apply the force to that spring. We don&rsquo;t take the easy way out here though so we are going to do this the right way. What we will do is use the Bounds of the object that fell in the water to determine exactly which springs should be affected. Additionally, if the object falls between all of our springs (this happens with small objects on mobile sometimes) we just grab the 2 closest springs and apply the force to them. Once we&rsquo;ve found all the affected springs, we first divide the force by the affected spring count. This will spread out the force. We then apply it to each spring by adding to its velocity.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">void</span> <span class="nf">splash</span><span class="p">(</span> <span class="n">Bounds</span> <span class="n">bounds</span><span class="p">,</span> <span class="kt">float</span> <span class="n">velocity</span> <span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="c1">// snip: setup code...</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// find all our springs within the bounds</span>
</span><span class='line'>  <span class="kt">var</span> <span class="n">xMin</span> <span class="p">=</span> <span class="n">bounds</span><span class="p">.</span><span class="n">min</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">var</span> <span class="n">xMax</span> <span class="p">=</span> <span class="n">bounds</span><span class="p">.</span><span class="n">max</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">for</span><span class="p">(</span> <span class="kt">var</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">_columns</span><span class="p">.</span><span class="n">Length</span><span class="p">;</span> <span class="n">i</span><span class="p">++</span> <span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="k">if</span><span class="p">(</span> <span class="n">_columns</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">xPosition</span> <span class="p">&gt;</span> <span class="n">xMin</span> <span class="p">&amp;&amp;</span> <span class="n">_columns</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">xPosition</span> <span class="p">&lt;</span> <span class="n">xMax</span> <span class="p">)</span>
</span><span class='line'>          <span class="n">_touchedColumnIndices</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span> <span class="n">i</span> <span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// if we have no hits we should loop back through and find the 2 closest verts and use them</span>
</span><span class='line'>  <span class="k">if</span><span class="p">(</span> <span class="n">_touchedColumnIndices</span><span class="p">.</span><span class="n">Count</span> <span class="p">==</span> <span class="m">0</span> <span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="k">for</span><span class="p">(</span> <span class="kt">var</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">_columns</span><span class="p">.</span><span class="n">Length</span><span class="p">;</span> <span class="n">i</span><span class="p">++</span> <span class="p">)</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="c1">// widen our search to included divisitionWidth padding on each side so we definitely get a couple hits</span>
</span><span class='line'>          <span class="k">if</span><span class="p">(</span> <span class="n">_columns</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">xPosition</span> <span class="p">+</span> <span class="n">_divisionWidth</span> <span class="p">&gt;</span> <span class="n">xMin</span> <span class="p">&amp;&amp;</span> <span class="n">_columns</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">xPosition</span> <span class="p">-</span> <span class="n">_divisionWidth</span> <span class="p">&lt;</span> <span class="n">xMax</span> <span class="p">)</span>
</span><span class='line'>              <span class="n">_touchedColumnIndices</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span> <span class="n">i</span> <span class="p">);</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// snip: updating velocity on affected WaterColumns and optionally spawning a splash prefab</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>That&rsquo;s all there is to the simulation. There is still more we can do to make it look better. The first gif showed what the water looks like with minimal springs/verts and only simple vertex colors. That is the low-end version of the water. Adding a refraction shader would give it a pretty neat look. You could also apply a blur shader that moves around and varies itself over time. The gif below uses a displacement map with a GrabPass to provide a bit of life to the water. Unfortunately, the low quality gif doesn&rsquo;t let you see the true beauty of the effect.</p>

<iframe src="http://gfycat.com/ifr/FreshGroundedAmericanmarten" frameborder="0" scrolling="no" width="846" height="478" style="-webkit-backface-visibility: hidden;-webkit-transform: scale(1);" ></iframe>


<p>Here is a snippet showing what this simple displacement shader is doing. The first pass of the shader is a GrabPass into the <em>GrabTexture. </em>DispTex is just a Texture2D of some noise. Playing around with different displacement textures ends up producing a variety of different looks with relative ease.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="n">half4</span> <span class="nf">frag</span><span class="p">(</span> <span class="n">v2f</span> <span class="n">i</span> <span class="p">)</span> <span class="p">:</span> <span class="n">COLOR</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="n">float2</span> <span class="n">displacement</span> <span class="p">=</span> <span class="n">tex2D</span><span class="p">(</span> <span class="n">_DispTex</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">grabUV</span> <span class="p">/</span> <span class="m">6.0</span> <span class="p">).</span><span class="n">xy</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">float</span> <span class="n">t</span> <span class="p">=</span> <span class="n">i</span><span class="p">.</span><span class="n">grabUV</span><span class="p">.</span><span class="n">y</span> <span class="p">+</span> <span class="n">displacement</span><span class="p">.</span><span class="n">y</span> <span class="p">*</span> <span class="m">0.1</span> <span class="p">-</span> <span class="m">0.07</span> <span class="p">+</span> <span class="p">(</span> <span class="n">sin</span><span class="p">(</span> <span class="n">i</span><span class="p">.</span><span class="n">grabUV</span><span class="p">.</span><span class="n">x</span> <span class="p">*</span> <span class="m">6.0</span> <span class="p">+</span> <span class="n">_Time</span><span class="p">.</span><span class="n">y</span> <span class="p">)</span> <span class="p">*</span> <span class="m">0.005</span> <span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">return</span> <span class="nf">tex2D</span><span class="p">(</span> <span class="n">_GrabTexture</span><span class="p">,</span> <span class="n">float2</span><span class="p">(</span> <span class="n">i</span><span class="p">.</span><span class="n">grabUV</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span> <span class="p">)</span> <span class="p">)</span> <span class="p">*</span> <span class="p">(</span> <span class="n">i</span><span class="p">.</span><span class="n">color</span> <span class="p">*</span> <span class="m">3.0</span> <span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Mike Desaro</span></span>

      




<time class='entry-date' datetime='2014-12-01T22:09:42-08:00'><span class='date'><span class='date-month'>Dec</span> <span class='date-day'>1</span><span class='date-suffix'>st</span>, <span class='date-year'>2014</span></span> <span class='time'>10:09 pm</span></time>
      


    </p>
    
      <div class="sharing">
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/water2d-part1" title="Previous Post: Modeling 2D Water with Springs: Part 1">&laquo; Modeling 2D Water with Springs: Part 1</a>
      
      
        <a class="basic-alignment right" href="/constants-generator-kit" title="Next Post: ConstantsGeneratorKit: Killing Naked Strings so You Don't Have To">ConstantsGeneratorKit: Killing Naked Strings so You Don&#8217;t Have To &raquo;</a>
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    
  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2015 - Mike Desaro -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  











</body>
</html>
